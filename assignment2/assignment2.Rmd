---
title: '**Spatial Economics -- Assignment 2**'
author: 
  - "Max Heinze (h11742049@s.wu.ac.at)"
  - "Jaime Miravet (h12235992@s.wu.ac.at)"
  - "Jan Trimmel (h11809096@s.wu.ac.at)"
date: "April 12, 2024"
output: 
  pdf_document:
    toc: true
    includes:
      in_header: !expr file.path(rprojroot::find_rstudio_root_file(), "helper", "wrap_code.tex")
header-includes: 
  - \usepackage{tcolorbox}
  - \usepackage{graphicx}
  - \usepackage{booktabs}
  - \usepackage[default]{lato}
papersize: a4
geometry: margin = 2cm
urlcolor: DarkOrchid!65!black
---

```{r, setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(showtext)
font_add_google("Lato", "Lato")
showtext_auto()
```

\vspace{2em}

\begin{tcolorbox}
\centering \itshape The executable code that was used in compiling the assignment is available on GitHub at \url{https://github.com/maxmheinze/spatial}.
\end{tcolorbox}

\newpage

# Task A

Text

\newpage

# Task B

## Nice Maps

We create four maps:

```{r, out.width = "60%", fig.align = "center", echo = FALSE}

# Header ------------------------------------------------------------------

pacman::p_load(
  tidyverse,
  tmap,
  haven,
  foreign,
  magrittr,
  sf,
  stargazer,
  conleyreg,
  estimatr,
  fixest
)


# Prepare Dataframe -------------------------------------------------------

litr <- read_dta("./assignment2/data/literacy_Arg-Bra-Par.dta", encoding = "ISO-8859-1")

shp0 <- read_sf("./assignment2/data/task_b_shapefile_0.shp")
shp1 <- read_sf("./assignment2/data/task_b_shapefile_1.shp")
shp2 <- read_sf("./assignment2/data/task_b_shapefile_2.shp")

spli <- shp2 %>%
  left_join(litr, by = c("NAME_2" = "muni"))


# Literacy Map ------------------------------------------------------------

tm_shape(spli) + 
  tm_fill("literacy", palette = "Reds", style = "equal", n = 10) + 
  tm_borders(col = "#BBBBBB") + 
  tm_shape(shp1) + 
  tm_borders(col = "#444444") + 
  tm_text("NAME_1", size = 0.75, col = "black", bg.color = "#FFFFFF") +
  tm_shape(shp0) + 
  tm_borders(col = "#000000") +
  tm_compass(position = c("right", "top"), size = 2) +
  tm_scale_bar(position = c("right", "bottom"), text.size = 0.5) +
  tm_layout(title = "Literacy Rate by Municipality", 
            title.bg.color = "white", 
            legend.position = c("left", "bottom"),
            legend.bg.color = "white", 
            frame = FALSE,
            fontfamily = "Lato")


# Population Density Map --------------------------------------------------

tm_shape(spli) + 
  tm_fill("popd", palette = "Blues", style = "quantile", n = 10) + 
  tm_borders(col = "#BBBBBB") + 
  tm_shape(shp1) + 
  tm_borders(col = "#444444") + 
  tm_text("NAME_1", size = 0.75, col = "black", bg.color = "#FFFFFF") +
  tm_shape(shp0) + 
  tm_borders(col = "#000000") +
  tm_compass(position = c("right", "top"), size = 2) +
  tm_scale_bar(position = c("right", "bottom"), text.size = 0.5) +
  tm_layout(title = "Population Density by Municipality", 
            title.bg.color = "white", 
            legend.position = c("left", "bottom"),
            legend.bg.color = "white", 
            frame = FALSE,
            fontfamily = "Lato")


# Jesuit Distance Map -----------------------------------------------------

tm_shape(spli) + 
  tm_fill("distmiss", palette = "Purples", style = "equal", n = 10) + 
  tm_borders(col = "#BBBBBB") + 
  tm_shape(shp1) + 
  tm_borders(col = "#444444") + 
  tm_text("NAME_1", size = 0.75, col = "black", bg.color = "#FFFFFF") +
  tm_shape(shp0) + 
  tm_borders(col = "#000000") +
  tm_compass(position = c("right", "top"), size = 2) +
  tm_scale_bar(position = c("right", "bottom"), text.size = 0.5) +
  tm_layout(title = "Distance from Jesuit Missions by Municipality", 
            title.bg.color = "white", 
            legend.position = c("left", "bottom"),
            legend.bg.color = "white", 
            frame = FALSE,
            fontfamily = "Lato")

# Franciscan Distance Map -------------------------------------------------

tm_shape(spli) + 
  tm_fill("distfran", palette = "Greens", style = "equal", n = 10) + 
  tm_borders(col = "#BBBBBB") + 
  tm_shape(shp1) + 
  tm_borders(col = "#444444") + 
  tm_text("NAME_1", size = 0.75, col = "black", bg.color = "#FFFFFF") +
  tm_shape(shp0) + 
  tm_borders(col = "#000000") +
  tm_compass(position = c("right", "top"), size = 2) +
  tm_scale_bar(position = c("right", "bottom"), text.size = 0.5) +
  tm_layout(title = "Distance from Franciscan Missions by Municipality", 
            title.bg.color = "white", 
            legend.position = c("left", "bottom"),
            legend.bg.color = "white", 
            frame = FALSE,
            fontfamily = "Lato")
```

## Replication of Table 2

Below are code and results of our replication of Table 2 from Valencia Caicedo (2019). Since the original author used Stata's robust standard errors, a notorious problem for replication in R, we specifically report Stata-style standard errors in the table below using the `starprep` function from the `estimatr` package. Using these standard errors, we can reproduce both coefficients and standard errors exactly.

```{r}

# Replicate Results -------------------------------------------------------
col1 <- lm(illiteracy ~ distmiss + lati + longi + corr + ita + mis + mis1, data = litr)
col2 <- lm(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr + ita + mis + mis1, data = litr)

litr_bra <- subset(litr, country == "BRA")
col3 <- lm(illiteracy ~ distmiss + lati + longi + as.factor(mesorregi), data = litr_bra)
col4 <- lm(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + as.factor(mesorregi), data = litr_bra)

litr_arg <- subset(litr, country == "Argentina")
col5 <- lm(illiteracy ~ distmiss + lati + longi + corr, data = litr_arg)
col6 <- lm(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr, data = litr_arg)

litr_pry <- subset(litr, country == "Paraguay")
col7 <- lm(illiteracy ~ distmiss + ita, data = litr_pry)
col8 <- lm(illiteracy ~ distmiss + area + tempe + alti + preci + rugg + river + coast + ita, data = litr_pry)

```

```{r, echo = FALSE, results='asis'}

cat("\\scalebox{.9}{")



stargazer(col1, col2, col3, col4,
          type = "latex", header=FALSE, no.space = TRUE, column.sep.width = "3pt", float = FALSE,
          se = starprep(col1, col2, col3, col4, se_type = "stata"),
          omit.stat = "f")

cat("}")
```

```{r, echo = FALSE, results='asis'}

cat("\\scalebox{.9}{")

stargazer(col5, col6, col7, col8,
          type = "latex", header=FALSE, no.space = TRUE, column.sep.width = "3pt", float = FALSE,
          se = starprep(col5, col6, col7, col8, se_type = "stata"),
          omit.stat = "f")

cat("}")
```

Next, we try to reproduce the Conley standard errors. We try two different approaches, first using the `conleyreg` package and then using the `fixest` package. Valencia Caicedo (2019) specifies a cutoff distance of 0.1 degrees. Both packages we use only allow us to specify the cutoff distance in kilometers, so for the sake of simplicity, we use the distance that 0.1 degrees equal at the equator, which is 6 nautical miles, or approximately 11.112 kilometers. We first print the results from the `conleyreg` package and then from the `fixest` package.

```{r}
lit1 <- litr %>%
  drop_na(lati, longi) %>%
  mutate(lat = lati,
         lon = longi)

col1c <- conleyreg(illiteracy ~ distmiss + lati + longi + corr + ita + mis + mis1, data = lit1,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")
col2c <- conleyreg(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr + ita + mis + mis1, data = lit1,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")

lit1_bra <- subset(lit1, country == "BRA")
col3c <- conleyreg(illiteracy ~ distmiss + lati + longi + as.factor(mesorregi), data = lit1_bra,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")
col4c <- conleyreg(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + as.factor(mesorregi), data = lit1_bra,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")

lit1_arg <- subset(lit1, country == "Argentina")
col5c <- conleyreg(illiteracy ~ distmiss + lati + longi + corr, data = lit1_arg,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")
col6c <- conleyreg(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr, data = lit1_arg,
           dist_cutoff = 11.112, lat = "lat", lon = "lon")

lit1_pry <- subset(lit1, country == "Paraguay")
col7c <- conleyreg(illiteracy ~ distmiss + ita, data =  lit1_pry,
                   dist_cutoff = 11.112, lat = "lat", lon = "lon")
col8c <- conleyreg(illiteracy ~ distmiss + area + tempe + alti + preci + rugg + river + coast + ita, data =  lit1_pry,
                   dist_cutoff = 11.112, lat = "lat", lon = "lon")
```

```{r, echo = FALSE, results='asis'}

cat("\\scalebox{.9}{")

stargazer(col1c, col2c, col3c, col4c, type = "latex", header=FALSE, no.space = TRUE, column.sep.width = "3pt", float = FALSE)

cat("}")
```

```{r, echo = FALSE, results='asis'}

cat("\\scalebox{.9}{")

stargazer(col5c, col6c, col7c, col8c, column.labels = c("(5)", "(6)", "(7)", "(8)"), model.numbers = FALSE, type = "latex", header=FALSE, no.space = TRUE, column.sep.width = "3pt", float = FALSE)

cat("}")
```

```{r}
col1cf <- feols(illiteracy ~ distmiss + lati + longi + corr + ita + mis + mis1, data = litr, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))
col2cf <- feols(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr + ita + mis + mis1, data = litr, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))

col3cf <- feols(illiteracy ~ distmiss + lati + longi + as.factor(mesorregi), data = litr_bra, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))
col4cf <- feols(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + as.factor(mesorregi), data = litr_bra, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))

col5cf <- feols(illiteracy ~ distmiss + lati + longi + corr, data = litr_arg, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))
col6cf <- feols(illiteracy ~ distmiss + lati + longi + area + tempe + alti + preci + rugg + river + coast + corr, data = litr_arg, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))

col7cf <- feols(illiteracy ~ distmiss + ita, data = litr_pry, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))
col8cf <- feols(illiteracy ~ distmiss + area + tempe + alti + preci + rugg + river + coast + ita, data = litr_pry, 
                 vcov_conley(lat = "lati", lon = "longi", cutoff = 11.112, distance = "spherical"))
```

```{r, echo = FALSE, results='asis'}
cat("\\scalebox{.8}{")
etable(col1cf, col2cf, col3cf, col4cf, col5cf, col6cf, col7cf, col8cf, tex = TRUE)
cat("}")
```

Evidently, we could not reproduce the exact Conley standard errors reported in Valencia Caicedo (2019). And the two packages yielded different errors even though we specified the same cutoff (11.112 kilometers) and the same method of distance calculation (spherical). 

\newpage

# Task C
## The perils of ignoring peer effects

\newpage

# Task D

The image is a screenshot, and those are conventionally stored in PNG format. The photo _contained_ in the screenshot is a photograph, and it is difficult to guess which format it was originally saved in. Let's say it's JPEG. Then, someone inserted the image into the assignment PDF, meaning it is technically not stored as a PNG anymore. What all those ways of storing the image have in common is that they are **raster formats**, as they consist of individual pixels. And even if we print the document containing the image, it gets printed as dots, which are not exactly pixels, but certainly form a raster rather than a vector.
