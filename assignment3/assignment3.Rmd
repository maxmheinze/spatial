---
title: '**Spatial Economics -- Assignment 3**'
author:
  - "Elia Di Gregorio (h12039313@s.wu.ac.at)"
  - "Max Heinze (h11742049@s.wu.ac.at)"
  - "Sophia Ludescher (h11801892@s.wu.ac.at)"
date: "May 3, 2024"
output: 
  pdf_document:
    toc: true
    citation_package: biblatex
    includes:
      in_header: !expr file.path(rprojroot::find_rstudio_root_file(), "helper", "wrap_code.tex")
bibliography: references.bib
biblio-style: apa
header-includes: 
  - \usepackage{tcolorbox}
  - \usepackage{graphicx}
  - \usepackage{booktabs}
  - \usepackage[default]{lato}
  - \usepackage{bm}
  - \usepackage{ulem}
papersize: a4
geometry: margin = 2cm
urlcolor: DarkOrchid!65!black
citecolor: DarkOrchid!65!black
---

```{r, setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(showtext)
font_add_google("Lato", "Lato")
showtext_auto()
```

\vspace{2em}

\begin{tcolorbox}
\centering \itshape The executable code that was used in compiling the assignment is available on GitHub at \url{https://github.com/maxmheinze/spatial}.
\end{tcolorbox}

\newpage

# Task A

## Naïve Panel Model and Specification Search

```{r load_packages, include = FALSE}
pacman::p_load(
  tidyverse,
  plm,
  readxl,
  spdep,
  splm,
  geosphere,
  igraph,
  stargazer,
  xtable,
  ggplot2,
  reshape2,
  viridis
)

cigs <- read_excel("./assignment3/data/cigarettes/cigarette+2var.xls")

cigw <- read_excel("./assignment3/data/cigarettes/Spat-Sym-US.xls", col_names = FALSE) %>%
  as.matrix()
```

We begin by fitting the spatially naïve panel model using the `plm` function. The output is printed below.

```{r fit_naive_panel}
cm1 <- plm(logc ~ logp + logy, 
           data = cigs,
           effect = "twoway",
           model = "within",
           index = c("state", "year"))
```

```{r print_naive_panel, echo = FALSE, results = "asis"}
cat("\\begin{center}")
stargazer(cm1, header = FALSE, float = FALSE)
cat("\\end{center}")
```

As the true spatial econometricians we are, we now ignore everything that is reminiscent of economic theory and venture on a standard specification testing path. We begin by performing a Lagrange Multiplier test for spatial lags in both the error and the dependent. The results are printed below.

```{r set_up_w, include = FALSE}
cign <- c("AL", "AZ", "AR", "CA", "CT", "DE", "DC", "FL", "GA", "ID", "IL", "IN", 
            "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", 
            "NE", "NV", "NH", "NJ", "NM", "NY", "ND", "OH", "OK", "PA", "RI", "SC", 
            "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")

dimnames(cigw) <- list(cign, cign)
rownames(cigw) <- cign
cigm <- mat2listw(cigw, style = "W")
```

```{r specification_tests_1}
slmtest(cm1, cigm, test = "lme")

slmtest(cm1, cigm, test = "lml")
```

As we can see, both tests return significant $p$-values, meaning that we reject the null hypotheses of spatial dependence being present in the errors or the dependent, respectively. We thus continue by performing robust LM tests for spatial dependence in both the errors and the dependent which account for the respectively other type of spatial dependence potentially being present. The results of these two tests are printed below.

```{r specification_tests_2}
slmtest(cm1, cigm, test = "rlme")

slmtest(cm1, cigm, test = "rlml")

```

Since this time, testing for spatial dependence in the error given spatial dependence in the dependent returns a significant result, and testing for spatial dependence in the dependent given spatial dependence in the errors does not, we conclude that based on these test results, a **SEM model** is the most appropriate specification.

## Estimating a SEM Model and Comparing it to an SLX Model

We use the `spml` function from the `splm` package to estimate a spatial panel model using Maximum Likelihood. Consistent with our previous answer, we estimate a **SEM model**, and we do this by setting `lag = FALSE` as well as `spatial.error = "b"`. Written down, the model equation is identical to the one presented in the assignment question, except for the important distinction that

$$
\bm{\varepsilon} = \rho\bm{W\varepsilon} + \bm{u},\quad\bm{u}\sim\mathrm{N}(\bm{0},\sigma^2\bm{I}).
$$

```{r fit_sem}
cm2 <- spml(
  logc ~ logp + logy, 
  data = cigs,
  listw = cigm,
  effect = "twoways",
  model = "within",
  index = c("state", "year"),
  lag = FALSE,
  spatial.error = "b"
)
```

```{r store_summary, include = FALSE}
cm2_summary <- summary(cm2)
cm2_coefs <- cm2_summary$CoefTable[,1]
cm2_serrs <- cm2_summary$CoefTable[,2]
```

The results of this estimation are printed in the following.

\begin{center}
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & logc \\ 
\hline \\[-1.8ex] 
 logp & $-$1.004$^{***}$ \\ 
  & (0.040) \\ 
  & \\ 
 logy & 0.554$^{***}$ \\ 
  & (0.049) \\ 
  & \\ \hline
 Spatial error rho & 0.240$^{***}$ \\ 
  & (0.033) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 1,380 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{center} 


Next, we estimate an **SLX model** using the `plm` function in combination with the `slag` function to create spatial lags. Since there neither is a lag of the dependent nor are there spatial errors, there is no need to use a function for a dedicatedly spatial panel model. The model we estimate below amounts to

$$
\bm{y}_t = \bm{X}_t\bm{\beta} + \bm{WX}_t\bm{\gamma} + \bm{\mu} + \phi_t\bm{\iota} + \bm{\varepsilon}_t,
$$

where, diverting from the original notation for ease of reading, $\bm{y}_t$ is a $n\times 1$ vector of stacked $\mathrm{log}(C_{it})$, $\bm{X}_t$ is a $n \times 2$ matrix consisting of stacked $\mathrm{log}(P_{it})$ and $\mathrm{log}(I_{it})$ as columns, $\bm{W}$ is the provided weights matrix, $\bm{\beta} = (\beta_1, \beta_2)'$, $\bm{\gamma} = (\gamma_1, \gamma_2)'$, and both $\bm{\mu}$ and $\bm{\varepsilon}$ are stacked over individuals and thus $n\times 1$ vectors.

```{r fit_slx}
cm3 <- plm(
  logc ~ logp + logy + slag(logp, listw = cigm) + slag(logy, listw = cigm), 
  data = cigs,
  effect = "twoways",
  model = "within",
  index = c("state", "year")
)
```

Again, the results are printed below.

```{r print_slx, echo = FALSE, results = "asis"}
cat("\\begin{center}")
stargazer(cm3, header = FALSE, float = FALSE)
cat("\\end{center}")
```

We can see that there is positive spatial autocorrelation of errors in the SEM model, and a negative spillover effect of price changes in the SLX model. The **positive spatial autocorrelation of errors** can be interpreted as that states that are contiguous are likely to experience similar shocks. This can be explained as spillover effects of an unobserved variable affecting cigarette demand; however, it is not possible to deduce information about the spillover effect of price changes, one of the explanatory variables in the model, from this error autocorrelation.

In contrast, the SLX model allows for directly examining and interpreting spillover effects, which could be the rationale for choosing it over the SEM (or a SAR) model. The coefficient we receive for **the effect of adjacent states' price changes**, $\gamma_1$, is $-$0.220. This can directly be interpreted as that given a one-unit increase in log price of cigarettes, log demand in adjacent states decreases by an average of 0.22 (or, if you want to be imprecise, the price of cigarettes increasing by one percent is associated with demand in adjacent states decreasing by an average of 0.22 percent), ceteris paribus.

Of course, this is really weird, or should at least strike us as such if we hold any belief in our original bootlegging hypothesis of people traveling to other states if cigarettes are cheaper there. This is because the above mentioned result indicates the exact opposite, i.e., if the price of cigarettes in State A increases, _less_ people will demand cigarettes in neighboring State B, where the price has _not_ increased.

## Distance Decay SLX

Since we know that results depend quite strongly on our choice of $\bm{W}$, it makes sense that \textcite{halleckvega2015} try a different $\bm{W}$ and we are asked to follow after them. So, in the following, we estimate an **SLX model with a distance decay specification**, where $w_{ij} = d_{ij}^{-\gamma}$ and $\gamma = 3$.

```{r setup_distance_decay}
cigd <- read_excel("./assignment3/data/cigarettes/cigar_states.xls") %>%
  select(longitude, latitude) %>%
  as.matrix() %>%
  `rownames<-`(cign)

cigi <- distm(cigd, fun = distVincentyEllipsoid)

cigj <- (cigi/1000000)^(-3) %>%
  `diag<-`(0) %>%
  mat2listw(style = "B")
```

```{r fit_distance_decay_slx}
cm4 <- plm(
  logc ~ logp + logy + slag(logp, listw = cigj) + slag(logy, listw = cigj), #SLX w/ distance decay
  data = cigs,
  effect = "twoways",
  model = "within",
  index = c("state", "year")
)
```

Again, the model results are printed below.

```{r print_distance_decay_slx, echo = FALSE, results = "asis"}
cat("\\begin{center}")
stargazer(cm4, header = FALSE, float = FALSE)
cat("\\end{center}")
```

We can see that this time, we actually get the suspected bootlegging effect, as $\gamma_1$ is positive. This may indicate that \sout{you get your desired results if you just try a large enough number of specifications} the distance decay matrix fits the true DGP better.

From a network perspective, this distance decay matrix has interesting implications. Our idea was that if there is a large number of edges, and these edges are weighted by the inverse of a power of the distance, then plotting these network must yield something that vaguely looks like the U.S. And it actually did:

```{r setup_matrix, include = FALSE}
cigk <- listw2mat(cigj) %>%
  `rownames<-`(cign) %>%
  `colnames<-`(cign)

cigg <- graph_from_adjacency_matrix((cigk), mode = "undirected")
```

```{r plot_graph, fig.width = 7, fig.height = 5, out.width = "100%", fig.align="center"}
plot(cigg,
     vertex.size = 10, 
     vertex.color = "#BBBBBB",
     vertex.label.cex = 0.7, 
     vertex.label.font = 2, 
     vertex.label.family = "Lato",
     vertex.label.color = "black",
     edge.color = "black",
     edge.width = 0.5,
     asp = 0) 
```

Since the plot is constructed anew every time we compile the document, we do not know how exactly it looks in our final submission. However, it should always resemble the true spatial position of the states recognizably---it may be flipped, it may be mirrored, it may not have north at the top, but the result should resemble the continental United States.

Then we thought about printing the weights matrix, only to find out that this is all but impossible on an A4 sheet of paper. So instead, here is a heatmap of the matrix:

```{r plot_heatmap, echo = FALSE, out.width="100%", fig.align="center"}
cigk_melted <- melt(cigk)

# Create the ggplot heatmap
ggplot(cigk_melted, aes(x = Var1, y = Var2, fill = log(value))) +
  geom_tile() +  # This creates the tiles for the heatmap
  scale_fill_viridis(name = "Value", option = "D") +  # Use viridis color scale
  theme_minimal() +  # Clean theme
  xlab("Column") +  # X-axis label
  ylab("Row")    # Y-axis label
```

Regarding centrality, we calculated two well-known measures: row sums (since our $\bm{W}$ is not row-stochastic) and eigenvector centrality. The results are printed below.

```{r print_rowsums}
rowSums(cigk) %>%
  sort(decreasing = TRUE) %>%
  knitr::kable(col.names = "Row Sum")
```

```{r print_eigenvector_centrality, echo = FALSE}
eigen_centrality(
  cigg,
  directed = FALSE,
  scale = TRUE,
  weights = NULL,
  options = arpack_defaults()
) %>%
  `$`(vector) %>%
  sort(decreasing = TRUE) %>%
  knitr::kable(col.names = "Eigenvector Centrality")
```

Using both measures of centrality, Maryland is the most central state, followed by DC as the second-most central entity. The then following positions differ a bit between the two measures of centrality.

Regarding the question where spillover effects occur, let us take another look at the model equation of the SLX model:

$$
\bm{y}_t = \bm{X}_t\bm{\beta} + \bm{WX}_t\bm{\gamma} + \bm{\mu} + \phi_t\bm{\iota} + \bm{\varepsilon}_t,
$$

The **spillover effect** we are interested in is described by $\gamma_1$, which in the equation is pre-multiplied by the first column of $\bm{WX}_t$. In a sense, the first column of $\bm{WX}_t$ determines where, or how strongly, spillover effects arise. Given a one-unit increase in every state's $\mathrm{log}(P_{it})$, this means that spillover effects of state $i$ on state $j$ will arise where $w_{ij}$ is large. For an illustration, you can thus refer to the heatmap above.

The **average partial effect** of increasing income

\newpage

# Task B

## Task B.1 - Unit of Observation

Describe the unit of observation:
* subnational “cells” --> grid squares 
* used to conduct a geographically disaggregated analysis of civil conflict and weather shocks

What are their areas?
* cells have dimensions of 110 km by 110 km (square)

Why and to which (relative) extent do they differ?
* spatial resolution?

## Task B.2 - Un-normalized weights matrix



\newpage
